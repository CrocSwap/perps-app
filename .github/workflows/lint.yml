name: Lint Check

on:
    pull_request:
        branches: [develop]

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: pnpm/action-setup@v2
              with:
                  version: 8
            - uses: actions/setup-node@v3
              with:
                  node-version: '18'
                  cache: 'pnpm'
            - run: pnpm install
            - name: Run linter
              id: lint
              run: |
                  # Run lint and capture output even if it fails
                  pnpm lint > lint-results.txt 2>&1 || true

                  # Count errors/warnings (adjust pattern based on your linter output format)
                  ERROR_COUNT=$(grep -c "error" lint-results.txt || echo 0)
                  WARNING_COUNT=$(grep -c "warning" lint-results.txt || echo 0)

                  # Set output variables for use in later steps
                  echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
                  echo "warning_count=$WARNING_COUNT" >> $GITHUB_OUTPUT

                  # Create warning annotation but don't fail the workflow
                  if [ "$ERROR_COUNT" -gt 0 ] || [ "$WARNING_COUNT" -gt 0 ]; then
                    echo "::warning::Found $ERROR_COUNT errors and $WARNING_COUNT warnings in linting"
                  fi
              continue-on-error: true

            - name: Post lint results as comment
              if: ${{ always() }}
              uses: actions/github-script@v6
              with:
                  github-token: ${{secrets.GITHUB_TOKEN}}
                  script: |
                      const fs = require('fs');
                      try {
                        // Get error/warning counts from previous step
                        const errorCount = parseInt('${{ steps.lint.outputs.error_count }}', 10) || 0;
                        const warningCount = parseInt('${{ steps.lint.outputs.warning_count }}', 10) || 0;
                        
                        let lintOutput = "No issues found";
                        if (fs.existsSync('lint-results.txt')) {
                          lintOutput = fs.readFileSync('lint-results.txt', 'utf8');
                        }
                        
                        // Create summary with counts
                        const summary = `## Lint Results Summary
                        
                        üìä **Stats:**
                        - Errors: ${errorCount}
                        - Warnings: ${warningCount}
                        - Total issues: ${errorCount + warningCount}
                        
                        ${errorCount + warningCount > 0 ? '‚ö†Ô∏è Please review the following issues:' : '‚úÖ All checks passed!'}
                        
                        \`\`\`
                        ${lintOutput}
                        \`\`\``;
                        
                        github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: summary
                        });
                      } catch (error) {
                        console.log("Error posting comment:", error);
                      }
